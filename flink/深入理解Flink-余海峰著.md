
# 第1章 流式数据架构理论

## 1.1 大数据处理架构演进历程

- **批处理**（batch）：在操作系统理论中，批处理是指用户将一批作业提交给操作系统后就不再干预，由操作系统控制它们自动运行。这种操作系统被称为批处理操作系统，它是为了提高CPU的利用率。
  在数据处理理论中有对应的批处理系统。批处理系统的核心功能是在大容量静态数据集上运行预定义功能的、可预期完成时间的计算任务。这里的静态是指数据集是有界的，是数据集的时间属性。
    
- **流处理**（streaming） 系统则是构建在无解数据集之上的、可提供实时计算的另一类数据处理系统。

## 1.3 流式数据架构基本概念
### 1.3.1 流

因此，从这个角度可以定义流是一种为无解数据集设计的数据处理引擎，这种引擎具备以下特征：
 （1）具备强一致性，即支持exactly-once语义
 （2）提供丰富的时间工具，如事件时间、处理时间、窗口。
 （3）保证系统具有可弹性、伸缩性。
 （4）同时保证系统高吞吐、低延迟与容错。
 （5）支持高层语义，如流式关系型API（SQL）、复杂事件处理（CEP，Complex Event Processing）

### 1.3.2 时间
在无界数据处理中，主要有两类事件概念：
（1）事件时间（Event Time）:事件实际发生的时间。
（2）处理时间（Processing Time）：事件被处理的时间。
 在Flink中还有个摄入时间，指数据流入FLink的时间
（3）摄入时间（Ingestion time）：事件进入Flink的时间

事件时间和处理时间有所偏差的主要原因如下：
（1）受共享资源局限：如网络阻塞延时、网络分区（参考CAP理论）、共享CPU等。
（2）软件架构：如分布式系统中的并发竞争、时钟不一致等。
（3）数据自身特性：如Key的特殊分布、吞吐量的快速涨落、乱序等。

- CAP定理
  CAP定理指出：一个分布式系统最多能具备一致性（Consistency）、可用性（Availability）以及分区容错性（Partition tolerance）中的两个特性，而不能同时具备这三个特性。
  （1）一致性：在分布式系统中同一数据的所有备份，在同一时刻，其值是相同的，或者说，所有客户端读取值是相同的。
  （2）可用性：在集群的部分节点出现故障后，集群还能正常响应客户端的读写请求。（对数据更新具备高可用性）
  （3）分区容错性：分区是对分布式系统通信时限的要求，即如果不能在有限时间内达成数据一致，则系统发生分区。所谓分区容错性，是指即使发生了分区，分布式系统仍然能正确响应客户端的读写请求。

### 1.3.3 窗口
  窗口（Window）是将（有界或无界）数据集拆分成一个个有限长度数据区间的机制，即在数据集中增加**临时**处理边界，用于将事件按照时间或者其他特征分组分析，其中临时这个定语说明窗口并没有物理地改变数据集。通常有三类窗口：
（1）滚动窗口（Tumbling Window）：将时间拆分成固定长度。
（2）滑动窗口（Sliding Window）：按照滑动步长（window slide）将时间拆分成固定的长度。
（3）会话窗口（Session Window）：以活动时间间隔为边界，将一系列连续事件拆分到不同的会话中。会话窗口的长度是动态的。

### 1.3.4 水印
Watermark 是 Apache Flink 为了处理 EventTime 窗口计算提出的一种机制, 本质上是一种时间戳。 一般来讲Watermark经常和Window一起被用来处理乱序事件。
  
Watermark 是一种衡量 Event Time 进展的机制，可以设定延迟触发
  
Watermark 是用于处理乱序事件的，而正确的处理乱序事件，通常用Watermark 机制结合 window 来实现；

[Flink事件时间、水印和迟到数据处理](https://cloud.tencent.com/developer/article/1586986)
[Flink教程-聊聊 flink 1.11 中新的水印策略](https://cloud.tencent.com/developer/article/1697930)

### 1.3.5 触发器
触发器（Trigger）决定在窗口的什么时间点启动应用程序定义的数据处理任务。

### 1.3.6 数据处理模式
1. 有界数据处理
2. 无界数据批处理
3. 无界数据流式处理

## 1.4 根据时间时间开滚动窗口

## 1.5 一致性
### 1.5.1 有状态计算
### 1.5.2 exactly-once语义
Flink的exactly-once：在系统发生故障恢复之后，聚合结果与假定没有发生故障情况时一致。这种语义加大了高吞吐和低延迟的实现难度，异步屏障快照技术是Flink提供这种语义的理论基础。
### 1.5.3 异步屏障快照
异步屏障快照（ABS，Asynchronous Barrier Snapshot）

### 1.5.4 保存点
检查点（Checkpoint）屏障由引擎负责实现，不需要数据处理应用程序编程。 
保存点（Savepoint）则由应用程序借助检查点底层机制实现一致性的应用层机制，广泛应用于数据处理程序平滑升级中。
检查点的目标是轻量，而保存点的目标是实现应用层的一致性功能。

# 第2章 编程基础

## 2.4 运行时
### 2.4.1 运行时结构
1. Task线程
  **线程**是程序运行时的最小单元，是进程中的一个实体，是被系统独立调度的基本单位，同属一个进程的所有线程共享进程所拥有的全部资源。
  Flink的每个Operator称为一个任务（task），Operator的每个实例称为子任务，每个任务（包括子任务）在一个JVM线程中执行。可以将多个子任务链接（chain）成一个任务，在一个线程中执行，这会降低程序上下文切换产生的开销，减小缓存容量，提高系统吞吐量的同时降低延迟。此外，这种链接机制是可配置的，这增强了数据处理应用程序的灵活性。

2. Manager进程
FLink 由两类运行时JVM进程（process）管理分布式集群的计算资源。
（1）JobManger 进程负责分布式任务管理，如任务调度、检查点、故障恢复等。JobManager是Flink主从架构中的master。
（2）TaskManger 进程负责执行任务线程，以及缓存和传输stream。TaskManager是FLink主从架构中的worker。

3. 线程共享Slot
为了控制执行的任务数量，TaskManager将计算资源划分为多个Slot，每个Slot独享给其分配的计算资源（如内存），这种静态的资源管理方式有利于任务间资源隔离。

Flink同一个作业的所有任务可以共享同一个Slot。但是不允许属于不同作业的任务共享同一个Slot。

### 2.4.2 任务调度
1. 调度策略
2. 作业控制
JobManager将计算图的逻辑形式（JobGraph）编译成物理部署形态（ExecutionGraph）：

Flink通过状态机管理ExecutionGraph的作业执行进度。

# 第3章 流处理API

## 3.2 时间处理
### 3.2.1 时间
Flink定义了三类时间:
处理时间（Processing Time）取自执行Operator的机器的系统时钟；
事件时间（Event Time）由数据源产生；
进入时间（Ingestion Time）记录被Source节点观察时的系统时间。

### 3.2.2 水印
水印是时间戳，由数据源嵌入或由Flink应用程序生成。
在事件顺序时，水印表明小于期时间戳的事件均已送达且大于其时间戳的事件还没有被观察到。
### 3.2.3 周期性水印生成器

## 3.3 算子
DataStream的算子将会有三个对应的内容：转换函数、数据分区与资源共享管理、状态与容错。
### 3.3.1 算子函数
1. map
2. KeyBy
3. Reduce
4. 聚合函数
5. 窗口函数
6. 连接
1）窗口连接
2）间隔连接

### 3.3.2 数据分区
### 3.3.3 资源共享
Flink将多个任务链接成一个任务在一个线程中执行在降低线程上下文切换的开销，减小缓存容量，提高系统吞吐量的同时降低延迟。这种机制是可配置的。
### 3.3.4 RichFunction


## 3.4 窗口
窗口是另一类算子，是DataStream的逻辑边界，在第一个元素到达后被创建，在生命周期结束后被销毁，但引擎不会确保及时销毁诸如全局窗口（Global Window）这类与时间无关的窗口。
除了开窗机制，应用程序还可以定义触发器（Trigger）、迟到生存期、窗口聚合函数（Window Function）及清除器（Evictor）。
窗口分为两大类，即Keyed Window和Non-Keyed Window。
### 3.4.1 窗口分类
1. 滚动窗口（Tumbling Window）：滚动窗口的时间长度是固定的，且不同时间区间的窗口不会重叠；
2. 滑动窗口（Sliding Window）：按照滑动步长将时间拆分成固定长度的窗口，当滑动步长小于窗口长度时，相邻窗口会重叠；
3. 会话窗口（Session Window）：根据相邻元素之间的时间间隔确定会话窗口的边界，其分为固定时间间隔（Static Gap）和动态时间间隔（Dynamic Gap），其中动态时间间隔由应用程序编程实现。
4. 全局窗口

### 3.4.2 窗口函数
1. 增量式计算
将计算任务均衡的分摊到前99s可以减轻第100s的计算压力，这被定义为**增量式计算**。
增量式计算增加了数据处理引擎架构设计的复杂度，但换取了计算性能的提升。
2. Reduce函数
3. 聚合函数（AggregateFunction）
聚合函数有三个泛型参数：窗口内数据类型（IN）、累加器类型（ACC）、聚合结果类型（OUT），其中累加器存放临时聚合结果。
4. 处理函数
处理函数（ProcessWindowFunction）可通过迭代器访问窗口内所有的元素，并可访问窗口上下文。
窗口上下文包括开窗机制、处理时间、水印、状态等。
5. 带窗口函数的聚合函数
### 3.4.3 触发器
### 3.4.4 清除器（Evictor）
### 3.4.5 迟到生存期
allowedLateness

## 3.5 连接器
### 3.5.2 Kafka
### 3.5.3 异步I/O
## 3.6 状态管理

### 3.6.3 状态后端配置（StateBackend）
状态后端有三种：
（1）内存（MemoryStateBackend）
（2）分布式文件系统(FsStateBackend)
（3）RocksDb（RocksDbStateBackend）

## 3.7 检查点
检查点是Flink实现exactly-once语义的核心机制，启动检查点机制需要具备一下两个条件：
（1）支持时空穿梭的外部数据源，如Kafka、分布式文件系统
（2）可持久化状态的外部存储，如分布式文件系统
# 第4章 批处理API
todo 后续再看

# 第八章 监控与部署
## 8.1 监控

### 8.1.3 监控配置
1. JMX
2. Graphite
3. Prometheus
4. StatsD
5. Datadog
6. Slf4j

## 8.2 集群部署模式
### 8.2.1 Standlone
### 8.2.2 YARN
### 8.2.3 高可用
